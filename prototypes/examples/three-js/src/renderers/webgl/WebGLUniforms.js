import{CubeTexture}from'../../textures/CubeTexture.js';import{Texture}from'../../textures/Texture.js';var emptyTexture=new Texture,emptyCubeTexture=new CubeTexture;function UniformContainer(){this.seq=[],this.map={}}var arrayCacheF32=[],arrayCacheI32=[],mat4array=new Float32Array(16),mat3array=new Float32Array(9);function flatten(a,b,c){var d=a[0];if(0>=d||0<d)return a;var e=b*c,f=arrayCacheF32[e];if(void 0===f&&(f=new Float32Array(e),arrayCacheF32[e]=f),0!==b){d.toArray(f,0);for(var g=1,h=0;g!==b;++g)h+=c,a[g].toArray(f,h)}return f}function allocTexUnits(a,b){var c=arrayCacheI32[b];c===void 0&&(c=new Int32Array(b),arrayCacheI32[b]=c);for(var d=0;d!==b;++d)c[d]=a.allocTextureUnit();return c}function setValue1f(a,b){a.uniform1f(this.addr,b)}function setValue1i(a,b){a.uniform1i(this.addr,b)}function setValue2fv(a,b){b.x===void 0?a.uniform2fv(this.addr,b):a.uniform2f(this.addr,b.x,b.y)}function setValue3fv(a,b){b.x===void 0?b.r===void 0?a.uniform3fv(this.addr,b):a.uniform3f(this.addr,b.r,b.g,b.b):a.uniform3f(this.addr,b.x,b.y,b.z)}function setValue4fv(a,b){b.x===void 0?a.uniform4fv(this.addr,b):a.uniform4f(this.addr,b.x,b.y,b.z,b.w)}function setValue2fm(a,b){a.uniformMatrix2fv(this.addr,!1,b.elements||b)}function setValue3fm(a,b){b.elements===void 0?a.uniformMatrix3fv(this.addr,!1,b):(mat3array.set(b.elements),a.uniformMatrix3fv(this.addr,!1,mat3array))}function setValue4fm(a,b){b.elements===void 0?a.uniformMatrix4fv(this.addr,!1,b):(mat4array.set(b.elements),a.uniformMatrix4fv(this.addr,!1,mat4array))}function setValueT1(a,b,c){var d=c.allocTextureUnit();a.uniform1i(this.addr,d),c.setTexture2D(b||emptyTexture,d)}function setValueT6(a,b,c){var d=c.allocTextureUnit();a.uniform1i(this.addr,d),c.setTextureCube(b||emptyCubeTexture,d)}function setValue2iv(a,b){a.uniform2iv(this.addr,b)}function setValue3iv(a,b){a.uniform3iv(this.addr,b)}function setValue4iv(a,b){a.uniform4iv(this.addr,b)}function getSingularSetter(a){return 5126===a?setValue1f:35664===a?setValue2fv:35665===a?setValue3fv:35666===a?setValue4fv:35674===a?setValue2fm:35675===a?setValue3fm:35676===a?setValue4fm:35678===a?setValueT1:35680===a?setValueT6:5124===a||35670===a?setValue1i:35667===a||35671===a?setValue2iv:35668===a||35672===a?setValue3iv:35669===a||35673===a?setValue4iv:void 0}function setValue1fv(a,b){a.uniform1fv(this.addr,b)}function setValue1iv(a,b){a.uniform1iv(this.addr,b)}function setValueV2a(a,b){a.uniform2fv(this.addr,flatten(b,this.size,2))}function setValueV3a(a,b){a.uniform3fv(this.addr,flatten(b,this.size,3))}function setValueV4a(a,b){a.uniform4fv(this.addr,flatten(b,this.size,4))}function setValueM2a(a,b){a.uniformMatrix2fv(this.addr,!1,flatten(b,this.size,4))}function setValueM3a(a,b){a.uniformMatrix3fv(this.addr,!1,flatten(b,this.size,9))}function setValueM4a(a,b){a.uniformMatrix4fv(this.addr,!1,flatten(b,this.size,16))}function setValueT1a(a,b,c){var d=b.length,e=allocTexUnits(c,d);a.uniform1iv(this.addr,e);for(var f=0;f!==d;++f)c.setTexture2D(b[f]||emptyTexture,e[f])}function setValueT6a(a,b,c){var d=b.length,e=allocTexUnits(c,d);a.uniform1iv(this.addr,e);for(var f=0;f!==d;++f)c.setTextureCube(b[f]||emptyCubeTexture,e[f])}function getPureArraySetter(a){return 5126===a?setValue1fv:35664===a?setValueV2a:35665===a?setValueV3a:35666===a?setValueV4a:35674===a?setValueM2a:35675===a?setValueM3a:35676===a?setValueM4a:35678===a?setValueT1a:35680===a?setValueT6a:5124===a||35670===a?setValue1iv:35667===a||35671===a?setValue2iv:35668===a||35672===a?setValue3iv:35669===a||35673===a?setValue4iv:void 0}function SingleUniform(a,b,c){this.id=a,this.addr=c,this.setValue=getSingularSetter(b.type)}function PureArrayUniform(a,b,c){this.id=a,this.addr=c,this.size=b.size,this.setValue=getPureArraySetter(b.type)}function StructuredUniform(a){this.id=a,UniformContainer.call(this)}StructuredUniform.prototype.setValue=function(a,b){for(var c,d=this.seq,e=0,f=d.length;e!==f;++e)c=d[e],c.setValue(a,b[c.id])};var RePathPart=/([\w\d_]+)(\])?(\[|\.)?/g;function addUniform(a,b){a.seq.push(b),a.map[b.id]=b}function parseUniform(a,b,c){var d=a.name,e=d.length;for(RePathPart.lastIndex=0;;){var f=RePathPart.exec(d),g=RePathPart.lastIndex,h=f[1],i=']'===f[2],j=f[3];if(i&&(h|=0),void 0===j||'['===j&&g+2===e){addUniform(c,void 0===j?new SingleUniform(h,a,b):new PureArrayUniform(h,a,b));break}else{var k=c.map,l=k[h];void 0===l&&(l=new StructuredUniform(h),addUniform(c,l)),c=l}}}function WebGLUniforms(a,b,c){UniformContainer.call(this),this.renderer=c;for(var d=a.getProgramParameter(b,a.ACTIVE_UNIFORMS),e=0;e<d;++e){var f=a.getActiveUniform(b,e),g=f.name,h=a.getUniformLocation(b,g);parseUniform(f,h,this)}}WebGLUniforms.prototype.setValue=function(a,b,c){var d=this.map[b];d!==void 0&&d.setValue(a,c,this.renderer)},WebGLUniforms.prototype.setOptional=function(a,b,c){var d=b[c];d!==void 0&&this.setValue(a,c,d)},WebGLUniforms.upload=function(a,b,c,d){for(var e=0,f=b.length;e!==f;++e){var g=b[e],h=c[g.id];!1!==h.needsUpdate&&g.setValue(a,h.value,d)}},WebGLUniforms.seqWithValue=function(a,b){for(var c,d=[],e=0,f=a.length;e!==f;++e)c=a[e],c.id in b&&d.push(c);return d};export{WebGLUniforms};