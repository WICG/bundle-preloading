import{AnimationAction}from'./AnimationAction.js';import{EventDispatcher}from'../core/EventDispatcher.js';import{LinearInterpolant}from'../math/interpolants/LinearInterpolant.js';import{PropertyBinding}from'./PropertyBinding.js';import{PropertyMixer}from'./PropertyMixer.js';import{AnimationClip}from'./AnimationClip.js';function AnimationMixer(a){this._root=a,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}Object.assign(AnimationMixer.prototype,EventDispatcher.prototype,{_bindAction:function(a,b){var c=a._localRoot||this._root,d=a._clip.tracks,e=d.length,f=a._propertyBindings,g=a._interpolants,h=c.uuid,j=this._bindingsByRootAndName,k=j[h];k===void 0&&(k={},j[h]=k);for(var l=0;l!==e;++l){var i=d[l],m=i.name,n=k[m];if(void 0!==n)f[l]=n;else{if(n=f[l],void 0!==n){null===n._cacheIndex&&(++n.referenceCount,this._addInactiveBinding(n,h,m));continue}var o=b&&b._propertyBindings[l].binding.parsedPath;n=new PropertyMixer(PropertyBinding.create(c,m,o),i.ValueTypeName,i.getValueSize()),++n.referenceCount,this._addInactiveBinding(n,h,m),f[l]=n}g[l].resultBuffer=n.buffer}},_activateAction:function(a){if(!this._isActiveAction(a)){if(null===a._cacheIndex){var b=(a._localRoot||this._root).uuid,c=a._clip.uuid,d=this._actionsByClip[c];this._bindAction(a,d&&d.knownActions[0]),this._addInactiveAction(a,c,b)}for(var e,f=a._propertyBindings,g=0,h=f.length;g!==h;++g)e=f[g],0==e.useCount++&&(this._lendBinding(e),e.saveOriginalState());this._lendAction(a)}},_deactivateAction:function(a){if(this._isActiveAction(a)){for(var b,c=a._propertyBindings,d=0,e=c.length;d!==e;++d)b=c[d],0==--b.useCount&&(b.restoreOriginalState(),this._takeBackBinding(b));this._takeBackAction(a)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var a=this;this.stats={actions:{get total(){return a._actions.length},get inUse(){return a._nActiveActions}},bindings:{get total(){return a._bindings.length},get inUse(){return a._nActiveBindings}},controlInterpolants:{get total(){return a._controlInterpolants.length},get inUse(){return a._nActiveControlInterpolants}}}},_isActiveAction:function(a){var b=a._cacheIndex;return null!==b&&b<this._nActiveActions},_addInactiveAction:function(a,b,c){var d=this._actions,e=this._actionsByClip,f=e[b];if(f===void 0)f={knownActions:[a],actionByRoot:{}},a._byClipCacheIndex=0,e[b]=f;else{var g=f.knownActions;a._byClipCacheIndex=g.length,g.push(a)}a._cacheIndex=d.length,d.push(a),f.actionByRoot[c]=a},_removeInactiveAction:function(a){var b=this._actions,c=b[b.length-1],d=a._cacheIndex;c._cacheIndex=d,b[d]=c,b.pop(),a._cacheIndex=null;var e=a._clip.uuid,f=this._actionsByClip,g=f[e],h=g.knownActions,i=h[h.length-1],j=a._byClipCacheIndex;i._byClipCacheIndex=j,h[j]=i,h.pop(),a._byClipCacheIndex=null;var k=g.actionByRoot,l=(a._localRoot||this._root).uuid;delete k[l],0===h.length&&delete f[e],this._removeInactiveBindingsForAction(a)},_removeInactiveBindingsForAction:function(a){for(var b,c=a._propertyBindings,d=0,e=c.length;d!==e;++d)b=c[d],0==--b.referenceCount&&this._removeInactiveBinding(b)},_lendAction:function(a){var b=this._actions,c=a._cacheIndex,d=this._nActiveActions++,e=b[d];a._cacheIndex=d,b[d]=a,e._cacheIndex=c,b[c]=e},_takeBackAction:function(a){var b=this._actions,c=a._cacheIndex,d=--this._nActiveActions,e=b[d];a._cacheIndex=d,b[d]=a,e._cacheIndex=c,b[c]=e},_addInactiveBinding:function(a,b,c){var d=this._bindingsByRootAndName,e=d[b],f=this._bindings;e===void 0&&(e={},d[b]=e),e[c]=a,a._cacheIndex=f.length,f.push(a)},_removeInactiveBinding:function(a){var b=this._bindings,c=a.binding,d=c.rootNode.uuid,e=c.path,f=this._bindingsByRootAndName,g=f[d],h=b[b.length-1],i=a._cacheIndex;h._cacheIndex=i,b[i]=h,b.pop(),delete g[e];remove_empty_map:{for(var j in g)break remove_empty_map;delete f[d]}},_lendBinding:function(a){var b=this._bindings,c=a._cacheIndex,d=this._nActiveBindings++,e=b[d];a._cacheIndex=d,b[d]=a,e._cacheIndex=c,b[c]=e},_takeBackBinding:function(a){var b=this._bindings,c=a._cacheIndex,d=--this._nActiveBindings,e=b[d];a._cacheIndex=d,b[d]=a,e._cacheIndex=c,b[c]=e},_lendControlInterpolant:function(){var a=this._controlInterpolants,b=this._nActiveControlInterpolants++,c=a[b];return void 0===c&&(c=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),c.__cacheIndex=b,a[b]=c),c},_takeBackControlInterpolant:function(a){var b=this._controlInterpolants,c=a.__cacheIndex,d=--this._nActiveControlInterpolants,e=b[d];a.__cacheIndex=d,b[d]=a,e.__cacheIndex=c,b[c]=e},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(a,b){var c=b||this._root,d=c.uuid,e='string'==typeof a?AnimationClip.findByName(c,a):a,f=null===e?a:e.uuid,g=this._actionsByClip[f],h=null;if(void 0!==g){var i=g.actionByRoot[d];if(void 0!==i)return i;h=g.knownActions[0],null===e&&(e=h._clip)}if(null===e)return null;var j=new AnimationAction(this,e,b);return this._bindAction(j,h),this._addInactiveAction(j,f,d),j},existingAction:function(a,b){var c=b||this._root,d=c.uuid,e='string'==typeof a?AnimationClip.findByName(c,a):a,f=e?e.uuid:a,g=this._actionsByClip[f];return void 0===g?null:g.actionByRoot[d]||null},stopAllAction:function(){var a=this._actions,b=this._nActiveActions,c=this._bindings,d=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var e=0;e!==b;++e)a[e].reset();for(var e=0;e!==d;++e)c[e].useCount=0;return this},update:function(a){a*=this.timeScale;for(var b,c=this._actions,d=this._nActiveActions,e=this.time+=a,f=Math.sign(a),g=this._accuIndex^=1,h=0;h!==d;++h)b=c[h],b._update(e,a,f,g);for(var i=this._bindings,j=this._nActiveBindings,h=0;h!==j;++h)i[h].apply(g);return this},getRoot:function(){return this._root},uncacheClip:function(a){var b=this._actions,c=a.uuid,d=this._actionsByClip,e=d[c];if(e!==void 0){for(var f,g=e.knownActions,h=0,i=g.length;h!==i;++h){f=g[h],this._deactivateAction(f);var j=f._cacheIndex,k=b[b.length-1];f._cacheIndex=null,f._byClipCacheIndex=null,k._cacheIndex=j,b[j]=k,b.pop(),this._removeInactiveBindingsForAction(f)}delete d[c]}},uncacheRoot:function(a){var b=a.uuid,c=this._actionsByClip;for(var d in c){var e=c[d].actionByRoot,f=e[b];f!==void 0&&(this._deactivateAction(f),this._removeInactiveAction(f))}var g=this._bindingsByRootAndName,h=g[b];if(h!==void 0)for(var i in h){var j=h[i];j.restoreOriginalState(),this._removeInactiveBinding(j)}},uncacheAction:function(a,b){var c=this.existingAction(a,b);null!==c&&(this._deactivateAction(c),this._removeInactiveAction(c))}});export{AnimationMixer};