import{LinearFilter,NearestFilter,RGBFormat,RGBAFormat,DepthFormat,DepthStencilFormat,UnsignedShortType,UnsignedIntType,UnsignedInt248Type,FloatType,HalfFloatType,ClampToEdgeWrapping,NearestMipMapLinearFilter,NearestMipMapNearestFilter}from'../../constants.js';import{_Math}from'../../math/Math.js';function WebGLTextures(a,b,c,d,e,f,g){function h(a,b){var c=Math.floor;if(a.width>b||a.height>b){var d=b/Math.max(a.width,a.height),e=document.createElementNS('http://www.w3.org/1999/xhtml','canvas');e.width=c(a.width*d),e.height=c(a.height*d);var f=e.getContext('2d');return f.drawImage(a,0,0,a.width,a.height,0,0,e.width,e.height),console.warn('THREE.WebGLRenderer: image is too big ('+a.width+'x'+a.height+'). Resized to '+e.width+'x'+e.height,a),e}return a}function k(a){return _Math.isPowerOfTwo(a.width)&&_Math.isPowerOfTwo(a.height)}function j(a){if(a instanceof HTMLImageElement||a instanceof HTMLCanvasElement){var b=document.createElementNS('http://www.w3.org/1999/xhtml','canvas');b.width=_Math.nearestPowerOfTwo(a.width),b.height=_Math.nearestPowerOfTwo(a.height);var c=b.getContext('2d');return c.drawImage(a,0,0,b.width,b.height),console.warn('THREE.WebGLRenderer: image is not power of two ('+a.width+'x'+a.height+'). Resized to '+b.width+'x'+b.height,a),b}return a}function l(a){return a.wrapS!==ClampToEdgeWrapping||a.wrapT!==ClampToEdgeWrapping||a.minFilter!==NearestFilter&&a.minFilter!==LinearFilter}function i(b){return b===NearestFilter||b===NearestMipMapNearestFilter||b===NearestMipMapLinearFilter?a.NEAREST:a.LINEAR}function m(a){var b=a.target;b.removeEventListener('dispose',m),o(b),g.textures--}function n(a){var b=a.target;b.removeEventListener('dispose',n),p(b),g.textures--}function o(b){var c=d.get(b);if(b.image&&c.__image__webglTextureCube)a.deleteTexture(c.__image__webglTextureCube);else{if(c.__webglInit===void 0)return;a.deleteTexture(c.__webglTexture)}d.remove(b)}function p(b){var c=d.get(b),e=d.get(b.texture);if(b){if(void 0!==e.__webglTexture&&a.deleteTexture(e.__webglTexture),b.depthTexture&&b.depthTexture.dispose(),b.isWebGLRenderTargetCube)for(var f=0;6>f;f++)a.deleteFramebuffer(c.__webglFramebuffer[f]),c.__webglDepthbuffer&&a.deleteRenderbuffer(c.__webglDepthbuffer[f]);else a.deleteFramebuffer(c.__webglFramebuffer),c.__webglDepthbuffer&&a.deleteRenderbuffer(c.__webglDepthbuffer);d.remove(b.texture),d.remove(b)}}function q(b,e){var f=d.get(b);if(0<b.version&&f.__version!==b.version){var g=b.image;if(g===void 0)console.warn('THREE.WebGLRenderer: Texture marked for update but image is undefined',b);else if(!1===g.complete)console.warn('THREE.WebGLRenderer: Texture marked for update but image is incomplete',b);else return void s(f,b,e)}c.activeTexture(a.TEXTURE0+e),c.bindTexture(a.TEXTURE_2D,f.__webglTexture)}function r(c,g,h){var j;if(h?(a.texParameteri(c,a.TEXTURE_WRAP_S,f(g.wrapS)),a.texParameteri(c,a.TEXTURE_WRAP_T,f(g.wrapT)),a.texParameteri(c,a.TEXTURE_MAG_FILTER,f(g.magFilter)),a.texParameteri(c,a.TEXTURE_MIN_FILTER,f(g.minFilter))):(a.texParameteri(c,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(c,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),(g.wrapS!==ClampToEdgeWrapping||g.wrapT!==ClampToEdgeWrapping)&&console.warn('THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.',g),a.texParameteri(c,a.TEXTURE_MAG_FILTER,i(g.magFilter)),a.texParameteri(c,a.TEXTURE_MIN_FILTER,i(g.minFilter)),g.minFilter!==NearestFilter&&g.minFilter!==LinearFilter&&console.warn('THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.',g)),j=b.get('EXT_texture_filter_anisotropic'),j){if(g.type===FloatType&&null===b.get('OES_texture_float_linear'))return;if(g.type===HalfFloatType&&null===b.get('OES_texture_half_float_linear'))return;(1<g.anisotropy||d.get(g).__currentAnisotropy)&&(a.texParameterf(c,j.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(g.anisotropy,e.getMaxAnisotropy())),d.get(g).__currentAnisotropy=g.anisotropy)}}function s(b,d,n){b.__webglInit===void 0&&(b.__webglInit=!0,d.addEventListener('dispose',m),b.__webglTexture=a.createTexture(),g.textures++),c.activeTexture(a.TEXTURE0+n),c.bindTexture(a.TEXTURE_2D,b.__webglTexture),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,d.flipY),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,d.premultiplyAlpha),a.pixelStorei(a.UNPACK_ALIGNMENT,d.unpackAlignment);var o=h(d.image,e.maxTextureSize);l(d)&&!1===k(o)&&(o=j(o));var p=k(o),q=f(d.format),s=f(d.type);r(a.TEXTURE_2D,d,p);var t,u=d.mipmaps;if(d.isDepthTexture){var v=a.DEPTH_COMPONENT;if(d.type===FloatType){if(!x)throw new Error('Float Depth Texture only supported in WebGL2.0');v=a.DEPTH_COMPONENT32F}else x&&(v=a.DEPTH_COMPONENT16);d.format===DepthFormat&&v===a.DEPTH_COMPONENT&&d.type!==UnsignedShortType&&d.type!==UnsignedIntType&&(console.warn('THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture.'),d.type=UnsignedShortType,s=f(d.type)),d.format===DepthStencilFormat&&(v=a.DEPTH_STENCIL,d.type!==UnsignedInt248Type&&(console.warn('THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture.'),d.type=UnsignedInt248Type,s=f(d.type))),c.texImage2D(a.TEXTURE_2D,0,v,o.width,o.height,0,q,s,null)}else if(d.isDataTexture){if(0<u.length&&p){for(var w=0,i=u.length;w<i;w++)t=u[w],c.texImage2D(a.TEXTURE_2D,w,q,t.width,t.height,0,q,s,t.data);d.generateMipmaps=!1}else c.texImage2D(a.TEXTURE_2D,0,q,o.width,o.height,0,q,s,o.data);}else if(d.isCompressedTexture)for(var w=0,i=u.length;w<i;w++)t=u[w],d.format!==RGBAFormat&&d.format!==RGBFormat?-1<c.getCompressedTextureFormats().indexOf(q)?c.compressedTexImage2D(a.TEXTURE_2D,w,q,t.width,t.height,0,t.data):console.warn('THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()'):c.texImage2D(a.TEXTURE_2D,w,q,t.width,t.height,0,q,s,t.data);else if(0<u.length&&p){for(var w=0,i=u.length;w<i;w++)t=u[w],c.texImage2D(a.TEXTURE_2D,w,q,q,s,t);d.generateMipmaps=!1}else c.texImage2D(a.TEXTURE_2D,0,q,q,s,o);d.generateMipmaps&&p&&a.generateMipmap(a.TEXTURE_2D),b.__version=d.version,d.onUpdate&&d.onUpdate(d)}function t(b,e,g,h){var i=f(e.texture.format),j=f(e.texture.type);c.texImage2D(h,0,i,e.width,e.height,0,i,j,null),a.bindFramebuffer(a.FRAMEBUFFER,b),a.framebufferTexture2D(a.FRAMEBUFFER,g,h,d.get(e.texture).__webglTexture,0),a.bindFramebuffer(a.FRAMEBUFFER,null)}function u(b,c){a.bindRenderbuffer(a.RENDERBUFFER,b),c.depthBuffer&&!c.stencilBuffer?(a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,c.width,c.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b)):c.depthBuffer&&c.stencilBuffer?(a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_STENCIL,c.width,c.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,b)):a.renderbufferStorage(a.RENDERBUFFER,a.RGBA4,c.width,c.height),a.bindRenderbuffer(a.RENDERBUFFER,null)}function v(b,c){var e=c&&c.isWebGLRenderTargetCube;if(e)throw new Error('Depth Texture with cube render targets is not supported!');if(a.bindFramebuffer(a.FRAMEBUFFER,b),!(c.depthTexture&&c.depthTexture.isDepthTexture))throw new Error('renderTarget.depthTexture must be an instance of THREE.DepthTexture');d.get(c.depthTexture).__webglTexture&&c.depthTexture.image.width===c.width&&c.depthTexture.image.height===c.height||(c.depthTexture.image.width=c.width,c.depthTexture.image.height=c.height,c.depthTexture.needsUpdate=!0),q(c.depthTexture,0);var f=d.get(c.depthTexture).__webglTexture;if(c.depthTexture.format===DepthFormat)a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,f,0);else if(c.depthTexture.format===DepthStencilFormat)a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.TEXTURE_2D,f,0);else throw new Error('Unknown depthTexture format')}function w(b){var c=d.get(b),e=!0===b.isWebGLRenderTargetCube;if(b.depthTexture){if(e)throw new Error('target.depthTexture not supported in Cube render targets');v(c.__webglFramebuffer,b)}else if(e){c.__webglDepthbuffer=[];for(var f=0;6>f;f++)a.bindFramebuffer(a.FRAMEBUFFER,c.__webglFramebuffer[f]),c.__webglDepthbuffer[f]=a.createRenderbuffer(),u(c.__webglDepthbuffer[f],b)}else a.bindFramebuffer(a.FRAMEBUFFER,c.__webglFramebuffer),c.__webglDepthbuffer=a.createRenderbuffer(),u(c.__webglDepthbuffer,b);a.bindFramebuffer(a.FRAMEBUFFER,null)}var x='undefined'!=typeof WebGL2RenderingContext&&a instanceof WebGL2RenderingContext;this.setTexture2D=q,this.setTextureCube=function(b,l){var n=d.get(b);if(6===b.image.length)if(0<b.version&&n.__version!==b.version){n.__image__webglTextureCube||(b.addEventListener('dispose',m),n.__image__webglTextureCube=a.createTexture(),g.textures++),c.activeTexture(a.TEXTURE0+l),c.bindTexture(a.TEXTURE_CUBE_MAP,n.__image__webglTextureCube),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,b.flipY);for(var o=b&&b.isCompressedTexture,p=b.image[0]&&b.image[0].isDataTexture,q=[],s=0;6>s;s++)q[s]=o||p?p?b.image[s].image:b.image[s]:h(b.image[s],e.maxCubemapSize);var i=q[0],t=k(i),u=f(b.format),v=f(b.type);r(a.TEXTURE_CUBE_MAP,b,t);for(var s=0;6>s;s++)if(!o)p?c.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,u,q[s].width,q[s].height,0,u,v,q[s].data):c.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,u,u,v,q[s]);else for(var w,x=q[s].mipmaps,y=0,j=x.length;y<j;y++)w=x[y],b.format!==RGBAFormat&&b.format!==RGBFormat?-1<c.getCompressedTextureFormats().indexOf(u)?c.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,y,u,w.width,w.height,0,w.data):console.warn('THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()'):c.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,y,u,w.width,w.height,0,u,v,w.data);b.generateMipmaps&&t&&a.generateMipmap(a.TEXTURE_CUBE_MAP),n.__version=b.version,b.onUpdate&&b.onUpdate(b)}else c.activeTexture(a.TEXTURE0+l),c.bindTexture(a.TEXTURE_CUBE_MAP,n.__image__webglTextureCube)},this.setTextureCubeDynamic=function(b,e){c.activeTexture(a.TEXTURE0+e),c.bindTexture(a.TEXTURE_CUBE_MAP,d.get(b).__webglTexture)},this.setupRenderTarget=function(b){var e=d.get(b),f=d.get(b.texture);b.addEventListener('dispose',n),f.__webglTexture=a.createTexture(),g.textures++;var h=!0===b.isWebGLRenderTargetCube,j=k(b);if(h){e.__webglFramebuffer=[];for(var l=0;6>l;l++)e.__webglFramebuffer[l]=a.createFramebuffer()}else e.__webglFramebuffer=a.createFramebuffer();if(h){c.bindTexture(a.TEXTURE_CUBE_MAP,f.__webglTexture),r(a.TEXTURE_CUBE_MAP,b.texture,j);for(var l=0;6>l;l++)t(e.__webglFramebuffer[l],b,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+l);b.texture.generateMipmaps&&j&&a.generateMipmap(a.TEXTURE_CUBE_MAP),c.bindTexture(a.TEXTURE_CUBE_MAP,null)}else c.bindTexture(a.TEXTURE_2D,f.__webglTexture),r(a.TEXTURE_2D,b.texture,j),t(e.__webglFramebuffer,b,a.COLOR_ATTACHMENT0,a.TEXTURE_2D),b.texture.generateMipmaps&&j&&a.generateMipmap(a.TEXTURE_2D),c.bindTexture(a.TEXTURE_2D,null);b.depthBuffer&&w(b)},this.updateRenderTargetMipmap=function(b){var e=b.texture;if(e.generateMipmaps&&k(b)&&e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter){var f=b&&b.isWebGLRenderTargetCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D,g=d.get(e).__webglTexture;c.bindTexture(f,g),a.generateMipmap(f),c.bindTexture(f,null)}}}export{WebGLTextures};