import{Box2}from'../../../math/Box2.js';import{Vector2}from'../../../math/Vector2.js';import{Vector3}from'../../../math/Vector3.js';function LensFlarePlugin(a,b){function c(){var a=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),b=new Uint16Array([0,1,2,0,2,3]);e=n.createBuffer(),f=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,e),n.bufferData(n.ARRAY_BUFFER,a,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,f),n.bufferData(n.ELEMENT_ARRAY_BUFFER,b,n.STATIC_DRAW),i=n.createTexture(),l=n.createTexture(),o.bindTexture(n.TEXTURE_2D,i),n.texImage2D(n.TEXTURE_2D,0,n.RGB,16,16,0,n.RGB,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),o.bindTexture(n.TEXTURE_2D,l),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,16,16,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),g={vertexShader:'uniform lowp int renderType;\nuniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform sampler2D occlusionMap;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif ( renderType == 2 ) {\nvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );\nvVisibility =        visibility.r / 9.0;\nvVisibility *= 1.0 - visibility.g / 9.0;\nvVisibility *=       visibility.b / 9.0;\nvVisibility *= 1.0 - visibility.a / 9.0;\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}',fragmentShader:'uniform lowp int renderType;\nuniform sampler2D map;\nuniform float opacity;\nuniform vec3 color;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nif ( renderType == 0 ) {\ngl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );\n} else if ( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * vVisibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}'},h=d(g),k={vertex:n.getAttribLocation(h,'position'),uv:n.getAttribLocation(h,'uv')},m={renderType:n.getUniformLocation(h,'renderType'),map:n.getUniformLocation(h,'map'),occlusionMap:n.getUniformLocation(h,'occlusionMap'),opacity:n.getUniformLocation(h,'opacity'),color:n.getUniformLocation(h,'color'),scale:n.getUniformLocation(h,'scale'),rotation:n.getUniformLocation(h,'rotation'),screenPosition:n.getUniformLocation(h,'screenPosition')}}function d(b){var c=n.createProgram(),d=n.createShader(n.FRAGMENT_SHADER),e=n.createShader(n.VERTEX_SHADER),f='precision '+a.getPrecision()+' float;\n';return n.shaderSource(d,f+b.fragmentShader),n.shaderSource(e,f+b.vertexShader),n.compileShader(d),n.compileShader(e),n.attachShader(c,d),n.attachShader(c,e),n.linkProgram(c),c}var e,f,g,h,k,m,i,l,n=a.context,o=a.state;this.render=function(d,g,p){if(0!==b.length){var q=new Vector3,r=p.w/p.z,s=0.5*p.z,t=0.5*p.w,u=16/p.w,v=new Vector2(u*r,u),w=new Vector3(1,1,0),x=new Vector2(1,1),y=new Box2;y.min.set(p.x,p.y),y.max.set(p.x+(p.z-16),p.y+(p.w-16)),void 0===h&&c(),n.useProgram(h),o.initAttributes(),o.enableAttribute(k.vertex),o.enableAttribute(k.uv),o.disableUnusedAttributes(),n.uniform1i(m.occlusionMap,0),n.uniform1i(m.map,1),n.bindBuffer(n.ARRAY_BUFFER,e),n.vertexAttribPointer(k.vertex,2,n.FLOAT,!1,16,0),n.vertexAttribPointer(k.uv,2,n.FLOAT,!1,16,8),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,f),o.disable(n.CULL_FACE),o.buffers.depth.setMask(!1);for(var z=0,A=b.length;z<A;z++){u=16/p.w,v.set(u*r,u);var B=b[z];if(q.set(B.matrixWorld.elements[12],B.matrixWorld.elements[13],B.matrixWorld.elements[14]),q.applyMatrix4(g.matrixWorldInverse),q.applyMatrix4(g.projectionMatrix),w.copy(q),x.x=p.x+w.x*s+s-8,x.y=p.y+w.y*t+t-8,!0===y.containsPoint(x)){o.activeTexture(n.TEXTURE0),o.bindTexture(n.TEXTURE_2D,null),o.activeTexture(n.TEXTURE1),o.bindTexture(n.TEXTURE_2D,i),n.copyTexImage2D(n.TEXTURE_2D,0,n.RGB,x.x,x.y,16,16,0),n.uniform1i(m.renderType,0),n.uniform2f(m.scale,v.x,v.y),n.uniform3f(m.screenPosition,w.x,w.y,w.z),o.disable(n.BLEND),o.enable(n.DEPTH_TEST),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0),o.activeTexture(n.TEXTURE0),o.bindTexture(n.TEXTURE_2D,l),n.copyTexImage2D(n.TEXTURE_2D,0,n.RGBA,x.x,x.y,16,16,0),n.uniform1i(m.renderType,1),o.disable(n.DEPTH_TEST),o.activeTexture(n.TEXTURE1),o.bindTexture(n.TEXTURE_2D,i),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0),B.positionScreen.copy(w),B.customUpdateCallback?B.customUpdateCallback(B):B.updateLensFlares(),n.uniform1i(m.renderType,2),o.enable(n.BLEND);for(var C,D=0,j=B.lensFlares.length;D<j;D++)C=B.lensFlares[D],1e-3<C.opacity&&1e-3<C.scale&&(w.x=C.x,w.y=C.y,w.z=C.z,u=C.size*C.scale/p.w,v.x=u*r,v.y=u,n.uniform3f(m.screenPosition,w.x,w.y,w.z),n.uniform2f(m.scale,v.x,v.y),n.uniform1f(m.rotation,C.rotation),n.uniform1f(m.opacity,C.opacity),n.uniform3f(m.color,C.color.r,C.color.g,C.color.b),o.setBlending(C.blending,C.blendEquation,C.blendSrc,C.blendDst),a.setTexture2D(C.texture,1),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0))}}o.enable(n.CULL_FACE),o.enable(n.DEPTH_TEST),o.buffers.depth.setMask(!0),a.resetGLState()}}}export{LensFlarePlugin};